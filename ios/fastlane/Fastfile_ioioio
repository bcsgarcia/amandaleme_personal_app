platform :ios do
    before_all do
      setup_ci
      load_asc_api_token
    end

    desc "Load the App Store Connect API token"
    lane :load_asc_api_token do
      app_store_connect_api_key(
        key_id: 'JS3MYV9HPQ',
        issuer_id: '513d5581-7fd6-470a-8e83-f2f97820b525',
        key_content: ENV["APP_STORE_CONNECT_API_KEY"],
        is_key_content_base64: true,
        in_house: false
      )
    end

    desc "Release a new build to TestFlight"
    lane :release_beta do
      sync_code_signing(
        api_key: lane_context[SharedValues::APP_STORE_CONNECT_API_KEY],
        type: "appstore",
        readonly: true,
      )

      build_number = latest_testflight_build_number + 1
      version_name = "1.0.0"

      Dir.chdir("../..") do
        sh("flutter", "build", "ipa", "--release", "--build-number=#{build_number}")
      end

      build_app(
        skip_build_archive: true,
        archive_path: "../build/ios/archive/Runner.xcarchive",
      )

      upload_to_testflight
    end
  end